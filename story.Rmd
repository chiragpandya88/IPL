---
title: "Story"
author: "Chirag Pandya"
date: "June 14, 2017"
output: html_document
---

#The Question  
The question to be answered here is "Given the previous data, who will win the next scheduled match?". There are various factors affecting this prediction. This report shows the importance of some features which may prove significant for prediction and also identifies other features which I will calculate from the data sets. The importance of this calculated features can only be confirmed once I build a model for prediction. 

#Data Sanity
The data is procured from a trusted source yet there are some sanity checks which are required to locate errors if any. I will start with reading the csv files.
```{r echo = FALSE}
#Libraries
library(ggplot2)
library(dplyr)
library(tidyr)
library(knitr)

#Reading the csv
matches <- read.csv("matches.csv")
deliveries <- read.csv("deliveries.csv")

#Merging the data sets
ipl <- merge(deliveries, matches, by.x = "match_id", by.y = "id" )
str(matches)
str(deliveries)
```

Starting with season, the dataset contains data for 9 seasons so there should be 9 distinct values of season in the whole set and values from 2008 to 2016.  

``` {r echo = FALSE}
unique(matches$season)
```

Moving forward plotting the value of city will show if there are any outliers.
``` {r echo = FALSE}
ggplot(matches[which(!is.na(matches$city)),],aes(city,fill= city,rm.na=T)) +geom_bar() +
theme(axis.text.x = element_text(angle = 90, hjust = 1))+ 
ylab("Number of Matches Played") +
guides(fill=FALSE)
```

The plot shows there are some blank values in the city. On further exploration, it was found that the city column was empty for matches in Dubai in the year 2014. This has been taken care of in the code. There are less number of matches in venues of South Africa as IPL 2009 was not held in India, due to the differences of Lalit Modi - Chairperson for IPL and the Indian home ministry. 

Moving on the team columns should have 13 unique values as there have been 13 teams participating in IPL over 9 years. This is confirmed by the following. 
```{r echo = FALSE}
unique(matches$team1)
unique(matches$team2)
```

Similary the toss decision variable should have a binary value of field or bat.
```{r echo = FALSE}
unique(matches$toss_decision)
```

Winner will have 14 distinct values i.e 13 for the teams and 1 when the match is tied. 
```{r echo = FALSE}
unique(matches$winner)
```

To find the number of outliers for the "win_by_runs" and "win_by_wickets" I have plotted both variables against the number of matches. This should give a fair idea if there is something wrong in the data.
```{r echo = FALSE}
ggplot(matches[matches$win_by_runs!=0,],aes(id,win_by_runs,col= winner )) + geom_point() +
  ylab("Runs won by ") + xlab("Matches won by team batting first")+
  ggtitle("Margin of Victories(Won by team batting first)")+ 
  scale_y_continuous(breaks=c(0,25,50,75,100))+
  geom_hline(yintercept = mean(matches[matches$win_by_runs!=0,]$win_by_runs),col="blue")
  
ggplot(matches[matches$win_by_wickets!=0,],aes(id,win_by_wickets,col= winner )) + geom_point() +
  ylab("Wickets won by ") + xlab("Matches won by team bowling first")+
  ggtitle("Margin of Victories(Won by team bowling first)")+
  scale_y_continuous(breaks=c(2,4,6,8,10))+
  geom_hline(yintercept = mean(matches[matches$win_by_wickets!=0,]$win_by_wickets),col="blue")
```

There are not more than 5 matches out of 577 which we can caetgorize as unusual. This is possible and hence no cleaning or exploration is required. 

#Exploration
I will start exploring the most basic features which contributes to the sentiments of the winning team. The first feature which I explore is toss statistics. I have plotted a graph to depict the behaviour of each team on winning or losing a toss. For that we add two more variables namely toss_match and winner_do. These variables show the team who won the toss won the match or not and what did the winning team opt for, i.e bat or field. 
```{r echo = FALSE}


#Tidying up
matches$umpire3 <- NULL
matches$toss_winner = matches$toss_winner %>% as.character()
matches$winner = matches$winner %>% as.character()
matches$winner = ifelse(matches$winner == "", "Tied", matches$winner) %>% as.factor()
matches$date = as.Date(matches$date)


#New Features for EDA
matches$toss_match = ifelse(matches$toss_winner == matches$winner, 1, 0) %>% as.factor()
matches$winner_do = ifelse(matches$win_by_runs>0, "bat", "field") %>% as.factor()

#Plotting toss win against number of wins
ggplot(matches, aes(reorder(winner, date), fill = toss_match)) + 
  geom_bar(color = "black", width = 0.8, position = position_dodge(width=0.8)) +
  xlab("Winning Team") + ylab("Number of wins") +
  ggtitle("Winning Team vs Winning Toss") + 
  scale_fill_discrete(guide = guide_legend(title = "toss_match")) +
  theme(axis.text.x=element_text(angle=75, hjust=1))
```

The plot shows that most teams have a higher winning percentage when they win the toss. The next feature which I will explore is "what does a winning team elect for: Bat OR Field". THis is to find out if there is a significant relevance of winning teams opting to bat or field first.
```{r echo = FALSE}
ggplot(matches, aes(reorder(winner, date), fill = winner_do)) + 
  geom_bar(color = "black", width = 0.8, position = position_dodge(width=0.8)) +
  xlab("Winning Team") + ylab("Number of wins") +
  ggtitle("Winning team bat first/field first") + 
  scale_fill_discrete(guide = guide_legend(title = "winner_do")) +
  theme(axis.text.x=element_text(angle=75, hjust=1))
```   

There are some very interesting fact depicted in this graph. The team Gujarat Lions seems to win most if it elects to field first. On the other hand teams like Chenna Superkings and Deccan chargers do well if they elect to bat first. Eventually, I will add a feature depicting whether the team elected to bat or field first.

Third imporant feature amongst others is the performance of teams on home and away grounds. I beleived that teams playing on their home grounds would perform better. The graph depics the winning percentage of teams depending upon the location i.e "Home" or "Away"
```{r echo = FALSE}
#Team Performance at Home ground and Away
t<-ipl %>% 
  filter((result=="normal" | result == "tie") & batting_team %in% c("Kolkata Knight Riders", "Royal Challengers Bangalore",
                                                                    "Chennai Super Kings","Kings XI Punjab","Rajasthan Royals",
                                                                    "Delhi Daredevils","Mumbai Indians","Gujarat Lions"))

#KKR Perforamance
kkr_match_played<-t %>% 
  filter(batting_team=="Kolkata Knight Riders") %>% 
  mutate(ground_type = if_else(city == "Kolkata","Home","Away")) %>% 
  group_by(ground_type) %>% 
  summarise(total_match_played = n_distinct(match_id))

kkr_match_won<-t %>% 
  filter(batting_team=="Kolkata Knight Riders" & winner == "Kolkata Knight Riders") %>% 
  mutate(ground_type = if_else(city == "Kolkata","Home","Away")) %>% 
  group_by(ground_type) %>% 
  summarise(total_win = n_distinct(match_id))

KKR<-merge(kkr_match_played, kkr_match_won, by ="ground_type")

KKR<-KKR %>% 
  mutate(winning_perc = (total_win/total_match_played)*100,
         team = "KKR") 

#Chennai Super Kings
csk_match_played<-t %>% 
  filter(batting_team=="Chennai Super Kings") %>% 
  mutate(ground_type = if_else(city == "Chennai","Home","Away")) %>% 
  group_by(ground_type) %>% 
  summarise(total_match_played = n_distinct(match_id))

csk_match_won<-t %>% 
  filter(batting_team=="Chennai Super Kings" & winner == "Chennai Super Kings") %>% 
  mutate(ground_type = if_else(city == "Chennai","Home","Away")) %>% 
  group_by(ground_type) %>% 
  summarise(total_win = n_distinct(match_id))

CSK<-merge(csk_match_played, csk_match_won, by ="ground_type")

CSK<-CSK %>% 
  mutate(winning_perc = (total_win/total_match_played)*100,
         team ="CSK") 

#Mumbai Indians
mi_match_played<-t %>% 
  filter(batting_team=="Mumbai Indians") %>% 
  mutate(ground_type = if_else(city == "Mumbai","Home","Away")) %>% 
  group_by(ground_type) %>% 
  summarise(total_match_played = n_distinct(match_id))

mi_match_won<-t %>% 
  filter(batting_team=="Mumbai Indians" & winner == "Mumbai Indians") %>% 
  mutate(ground_type = if_else(city == "Mumbai","Home","Away")) %>% 
  group_by(ground_type) %>% 
  summarise(total_win = n_distinct(match_id))

MI<-merge(mi_match_played, mi_match_won, by ="ground_type")

MI<-MI %>% 
  mutate(winning_perc = (total_win/total_match_played)*100,
         team= "MI") 

#Kings XI punjab
KXIP_match_played<-t %>% 
  filter(batting_team=="Kings XI Punjab") %>% 
  mutate(ground_type = if_else(city == "Chandigarh","Home","Away")) %>% 
  group_by(ground_type) %>% 
  summarise(total_match_played = n_distinct(match_id))

KXIP_match_won<-t %>% 
  filter(batting_team=="Kings XI Punjab" & winner == "Kings XI Punjab") %>% 
  mutate(ground_type = if_else(city == "Chandigarh","Home","Away")) %>% 
  group_by(ground_type) %>% 
  summarise(total_win = n_distinct(match_id))

KXIP<-merge(KXIP_match_played, KXIP_match_won, by ="ground_type")

KXIP<-KXIP %>% 
  mutate(winning_perc = (total_win/total_match_played)*100,
         team="KXIP") 
#Rajasthan Royal
RR_match_played<-t %>% 
  filter(batting_team=="Rajasthan Royals") %>% 
  mutate(ground_type = if_else(city == "Jaipur","Home","Away")) %>% 
  group_by(ground_type) %>% 
  summarise(total_match_played = n_distinct(match_id))

RR_match_won<-t %>% 
  filter(batting_team=="Rajasthan Royals" & winner == "Rajasthan Royals") %>% 
  mutate(ground_type = if_else(city == "Jaipur","Home","Away")) %>% 
  group_by(ground_type) %>% 
  summarise(total_win = n_distinct(match_id))

RR<-merge(RR_match_played, RR_match_won, by ="ground_type")

RR<-RR %>% 
  mutate(winning_perc = (total_win/total_match_played)*100,
         team = "RR") 

#Royal Challengers Bangalore
RCB_match_played<-t %>% 
  filter(batting_team=="Royal Challengers Bangalore") %>% 
  mutate(ground_type = if_else(city == "Bangalore","Home","Away")) %>% 
  group_by(ground_type) %>% 
  summarise(total_match_played = n_distinct(match_id))

RCB_match_won<-t %>% 
  filter(batting_team=="Royal Challengers Bangalore" & winner == "Royal Challengers Bangalore") %>% 
  mutate(ground_type = if_else(city == "Bangalore","Home","Away")) %>% 
  group_by(ground_type) %>% 
  summarise(total_win = n_distinct(match_id))

RCB<-merge(RCB_match_played, RCB_match_won, by ="ground_type")

RCB<-RCB %>% 
  mutate(winning_perc = (total_win/total_match_played)*100,
         team ="RCB")

#Delhi Daredevils

DD_match_played<-t %>% 
  filter(batting_team=="Delhi Daredevils") %>% 
  mutate(ground_type = if_else(city == "Delhi","Home","Away")) %>% 
  group_by(ground_type) %>% 
  summarise(total_match_played = n_distinct(match_id))

DD_match_won<-t %>% 
  filter(batting_team=="Delhi Daredevils" & winner == "Delhi Daredevils") %>% 
  mutate(ground_type = if_else(city == "Delhi","Home","Away")) %>% 
  group_by(ground_type) %>% 
  summarise(total_win = n_distinct(match_id))

DD<-merge(DD_match_played, DD_match_won, by ="ground_type")

DD<-DD %>% 
  mutate(winning_perc = (total_win/total_match_played)*100,
         team = "DD")


#Gujarat Lions

GL_match_played<-t %>% 
  filter(batting_team=="Gujarat Lions") %>% 
  mutate(ground_type = if_else(city == "Rajkot","Home","Away")) %>% 
  group_by(ground_type) %>% 
  summarise(total_match_played = n_distinct(match_id))

GL_match_won<-t %>% 
  filter(batting_team=="Gujarat Lions" & winner == "Gujarat Lions") %>% 
  mutate(ground_type = if_else(city == "Rajkot","Home","Away")) %>% 
  group_by(ground_type) %>% 
  summarise(total_win = n_distinct(match_id))

GL<-merge(GL_match_played, GL_match_won, by ="ground_type")

GL <-GL %>% 
  mutate(winning_perc = (total_win/total_match_played)*100,
         team = "GL")

team_performances<-rbind(CSK,DD,KKR,MI,KXIP,RCB,RR,GL)
team_performances <- team_performances[,c(5,1,2,3,4)]
View(team_performances)

team_performances %>% 
  ggplot(aes(x = team, y = winning_perc,fill = ground_type))+
  geom_bar(stat = "identity", position = "dodge")+
  labs(list(title = "Teams Performance", x = "Team", y = "Winning Percentage"))+
  theme(axis.text.x=element_text(angle=75, hjust=1), plot.title = element_text(size = 8, face = "bold"),text = element_text(size=8))

```   

It seems that most teams perform well in their home grounds. Except for Gujarat Lions and Delhi Daredevils. On digging deeper, we find that Gujarat Lions have played only 16 matches as the team was formulated in 2016. Out of these 16 matches, they have played only 5 matches on their home ground. From these, they have won 2 matches. This is the reason for the anomaly in the graph and the data is too small to make a generalized statement about the team. This also depicts that predicting results for the team of Gujarat Lions may result in lesser accuracy. It may also be required to drop predictions for Gujarat Lions.

The following table shows the total number of matches played by each team on their home ground and away ground and their winning percentages. This should give a fair idea of the imporatance of home and away grounds.
```{r echo = FALSE}
team_performances
```   

These are some of the performance  metrics which affect team performance and may help in predicting wins in the future. The next section is about identify a feature vector to be provided to the model for prediction.

#Feature Vector

The following are the suggested feature vectors. This list may change with time as per the deductions of importance from the model's Beta and t values. 


Percentage of matches won by team 1
int

Number of matches won by team 1
int

Winning record (Number of matches won - number of matches lost)
ternary int
positive value = 1
equal value = 0
negative value = 1

Team1 home/away 
Binary int
home = 1
away = 0

Team2 home/away 
Binary int
home = 1
away = 0

Team1 toss win
binary int
win = 1
lose = 0

Team2 toss win
binary int
win = 1
lose = 0

Team1 net run rate i.e runrate of team1 - run rate of team2
float

Team2 net run rate i.e runrate of team2 - run rate of team1
float

Average run rate of team1
float

Average run rate of team2
float

Average wicket rate per over team1
int (rounded)

Average wicket rate per over team2
int(rounded)


